#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "requests",
# ]
# ///

import json
import subprocess
import sys
from pathlib import Path

CONFIG_PATH = Path.home() / ".config" / "fast-commit" / ".env"

SYSTEM_PROMPT = """You are a git commit message generator. Given a git diff, analyse the changes and group them into logical atomic commits.

Rules:
- Each commit should represent one logical change
- Use conventional commit format: <type>(<scope>): <subject>
- Types: feat, fix, refactor, chore, docs, style, test, perf
- Subject: imperative mood, max 50 chars, no period
- Group files that belong to the same logical change together
- If all changes are one logical unit, return a single commit

Respond with ONLY a JSON array (no markdown, no explanation):
[
  {
    "files": ["path/to/file1", "path/to/file2"],
    "message": "feat(auth): add login endpoint"
  }
]

If a file is deleted, still include it in the files list - git add handles deletions.
If a file is renamed, include both old and new paths.
"""


def load_config():
    if not CONFIG_PATH.exists():
        print(f"error: config not found at {CONFIG_PATH}", file=sys.stderr)
        print(f"create it with OPENROUTER_API_KEY and MODEL", file=sys.stderr)
        sys.exit(1)
    config = {}
    for line in CONFIG_PATH.read_text().splitlines():
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        key, _, value = line.partition("=")
        config[key.strip()] = value.strip().strip("\"'")
    if "OPENROUTER_API_KEY" not in config:
        print("error: OPENROUTER_API_KEY not set in config", file=sys.stderr)
        sys.exit(1)
    if "MODEL" not in config:
        print("error: MODEL not set in config", file=sys.stderr)
        sys.exit(1)
    return config


def run(cmd):
    result = subprocess.run(cmd, capture_output=True, text=True)
    return result.stdout, result.returncode


def get_diff():
    staged, _ = run(["git", "diff", "--cached", "--name-only"])
    if staged.strip():
        diff, _ = run(["git", "diff", "--cached"])
        return diff, "staged"
    diff, _ = run(["git", "diff"])
    if not diff.strip():
        untracked, _ = run(["git", "ls-files", "--others", "--exclude-standard"])
        if not untracked.strip():
            return "", "none"
        subprocess.run(["git", "add", "-A"], check=True)
        diff, _ = run(["git", "diff", "--cached"])
        return diff, "all"
    subprocess.run(["git", "add", "-A"], check=True)
    diff, _ = run(["git", "diff", "--cached"])
    return diff, "all"


MAX_DIFF_CHARS = 20000
MAX_LINES_PER_FILE = 30


def compress_diff(diff):
    stat, _ = run(["git", "diff", "--cached", "--stat"])
    files_patches = []
    current_file = None
    current_lines = []
    line_count = 0
    for line in diff.splitlines():
        if line.startswith("diff --git"):
            if current_file:
                files_patches.append((current_file, current_lines))
            current_file = line
            current_lines = []
            line_count = 0
        elif current_file:
            line_count += 1
            if line_count <= MAX_LINES_PER_FILE:
                current_lines.append(line)
            elif line_count == MAX_LINES_PER_FILE + 1:
                current_lines.append("[... truncated]")
    if current_file:
        files_patches.append((current_file, current_lines))
    parts = [f"DIFF STAT:\n{stat}\nTRUNCATED PATCHES:"]
    for header, lines in files_patches:
        parts.append(header)
        parts.extend(lines)
    return "\n".join(parts)


def call_llm(config, diff):
    import requests

    content = diff if len(diff) <= MAX_DIFF_CHARS else compress_diff(diff)

    resp = requests.post(
        "https://openrouter.ai/api/v1/chat/completions",
        headers={
            "Authorization": f"Bearer {config['OPENROUTER_API_KEY']}",
            "Content-Type": "application/json",
        },
        json={
            "model": config["MODEL"],
            "messages": [
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": content},
            ],
            "temperature": 0,
        },
        timeout=60,
    )
    if resp.status_code != 200:
        print(f"error: LLM API returned {resp.status_code}: {resp.text}", file=sys.stderr)
        sys.exit(1)
    content = resp.json()["choices"][0]["message"]["content"]
    content = content.strip()
    if content.startswith("```"):
        content = "\n".join(content.split("\n")[1:])
    if content.endswith("```"):
        content = "\n".join(content.split("\n")[:-1])
    return json.loads(content)


def main():
    config = load_config()

    diff, source = get_diff()
    if not diff:
        print("nothing to commit")
        return

    print(f"analysing {source} changes...")
    commits = call_llm(config, diff)

    if source == "all":
        subprocess.run(["git", "reset", "HEAD"], capture_output=True)

    for commit in commits:
        files = commit["files"]
        message = commit["message"]
        subprocess.run(["git", "add", "--"] + files, check=True)
        result = subprocess.run(["git", "commit", "-m", message], capture_output=True, text=True)
        if result.returncode != 0:
            print(f"error: commit failed: {result.stderr}", file=sys.stderr)
            sys.exit(1)
        print(f"  {message}")

    result = subprocess.run(["git", "push"], capture_output=True, text=True)
    if result.returncode != 0:
        print(f"error: push failed: {result.stderr}", file=sys.stderr)
        sys.exit(1)
    print("pushed")


if __name__ == "__main__":
    main()
